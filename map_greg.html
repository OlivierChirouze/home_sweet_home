<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Carte communes</title>
    <script>

        function getJson(jsonUrl, callback) {
            let request = new XMLHttpRequest();
            request.onload = callback;
            request.open('GET', jsonUrl);
            request.send();
        }

        function addScript(scriptSrc) {
            let header = document.getElementsByTagName("head")[0];
            let scriptTag = document.createElement("script");
            scriptTag.type = "text/javascript";
            scriptTag.src = scriptSrc;
            header.appendChild(scriptTag);
        }

        var cities = [];
        var config = {};

        getJson('config.json', function () {
            config = JSON.parse(this.responseText);

            getJson('cities.json', function () {
                cities = JSON.parse(this.responseText).cities;
                addScript("https://maps.googleapis.com/maps/api/js?key=" + config.key + "&callback=initMap");
            });
        });


        var type = "order";

        var map;

        var max = 30;

        function getColorFromOrder(i) {
            let color;
            if (i <= 20) {
                color = "#40ff00";
            } else if (i <= 40) {
                color = "#54fcff";
            } else if (i <= 60) {
                color = "#ffd176";
            } else {
                color = "#ff0000";
            }

            return color
        }

        function updateMarkers() {
            for (let i in cities) {

                let city = cities[i];

                if ((Number(i) + 1) <= max) {
                    switch (type) {
                        case "order":
                        case "order_name":
                            label = "" + (Number(i) + 1);
                            if (type === "order_name") label += " " + city.n;
                            color = getColorFromOrder(i);
                            break;
                        case "c":
                            label = "" + city.c;
                            color = getColorFromDuration(city.c, 45, 50, 60);
                            break;
                        case "o":
                            label = "" + city.o;
                            color = getColorFromDuration(city.o, 50, 60, 70);
                            break;
                    }

                    city.marker.label.text = label;
                    city.marker.icon.fillColor = color;
                    city.marker.icon.strokeColor = color;

                    city.marker.opacity = 1;
                } else {
                    city.marker.opacity = 0;
                }

                // Refresh
                city.marker.setMap(null);
                city.marker.setMap(map);
            }
        }

        function getColorFromDuration(durationString, a, b, c) {
            let dur = getDuration(durationString);
            let color;
            if (dur <= a) {
                color = "#40ff00";
            } else if (dur <= b) {
                color = "#54fcff";
            } else if (dur <= c) {
                color = "#ffd176";
            } else {
                color = "#ff0000";
            }

            return color;
        }

        function getDuration(durationString) {
            var arr = durationString.split(":");
            return Number(arr[0]) * 60 + Number(arr[1]);
        }

        function getUrl(city) {
            var cityLocation = Number(city.lat.replace(',', '.')) + "," + Number(city.lng.replace(',', '.'));
            var url = "https://www.google.com/maps/dir/"
                + encodeURIComponent(city.via)
                + "/" + cityLocation
                + "/" + encodeURIComponent("115 Chemin de l'Islon, 38670 Chasse-sur-RhÃ´ne")
                + "/@45.4719624,5.0736569,11z/";
            return url;
        }

        function initMap() {
            var geocoder = new google.maps.Geocoder();

            function addMarker(position) {

                var displayPos = Number(position) + 1;

                var city = cities[position];

                var location = {
                    lat: Number(city.lat.replace(',', '.')),
                    lng: Number(city.lng.replace(',', '.'))
                };
                if (!map) {
                    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 11,
                        center: location
                    });
                }

                // https://developers.google.com/maps/documentation/javascript/reference/3.exp/marker#MarkerOptions
                city.marker = new google.maps.Marker({
                    position: location,
                    label: {
                        text: "...",
                        fontSize: "10px"
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#eee",
                        fillOpacity: 1,
                        strokeColor: "#eee"
                    },
                    title: city.n + "\n"
                    + "o : " + city.o + " (" + city.o_d + ")\n"
                    + "c : " + city.c + "\n"
                    + "via " + city.via,
                    map: map,
                    zIndex: 1 / displayPos,
                    clickable: true,
                    opacity: 0
                });

                city.marker.addListener('click', function (event) {
                    var url = getUrl(city);

                    window.open(
                        url,
                        city.n
                    );
                });
            }

            for (let position in cities) {
                addMarker(position);
            }

            document.getElementById("max").value = max;

            updateMarkers();
        }
    </script>
    <style>
        #map {
            height: 700px;
            width: 100%;
        }
    </style>
</head>
<body>
top :
<select id="max" onchange="console.log(this.value);max=this.value;updateMarkers()">
    <option>10</option>
    <option>20</option>
    <option>30</option>
    <option>40</option>
    <option>50</option>
    <option>60</option>
    <option>80</option>
    <option>90</option>
    <option>100</option>
    <option>110</option>
</select>
<button onclick="window.type='order';updateMarkers();">classement</button>
<button onclick="window.type='order_name';updateMarkers();">noms</button>
<button onclick="window.type='o';updateMarkers();">Greg</button>
<button onclick="window.type='c';updateMarkers();">Cindy</button>
<div id="map"></div>
</body>
</html>